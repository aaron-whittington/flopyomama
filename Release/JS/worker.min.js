var nsWorker={};self.addEventListener("message",function(a){a=a.data;switch(a.cmd){case "start":a.bMin?importScripts("lib.min.js"):importScripts("../lib/underscore/underscore-min.js","Maths.js","Hand.js","Convert.js");nsWorker.fCalculateBoards(a.aoStartingHands,a.aKnownCards,a.aUnknownCards,a.aFixedBoardCards,a.numberOfOpenBoardHandPlaces,a.oFilter);break;case "stop":self.close();break;default:self.postMessage("Unknown command: "+a.msg)}},!1);
nsWorker.fCalculateBoards=function(a,d,b,f,g,u){var E=(new Date).getTime(),x=fNumberOfCombinations(b.length,g),r=0;self.fPostConsole("now starting operation");for(var l=nsHand,p=[],v=a.length,s=0,c=0;c<v;c++){var m=a[c].aPair;p.push(m);s+=m.length}x=x*s/1.14;m=fCombinatorics(b,g);0==m.length&&(m[0]=[]);for(var p=g=b=0,v={},s={},t=m.length-1;0<=t;t--){for(var y=d,y=y.concat(m[t]),z=l.fGetBestHand(y),D=f.concat(m[t]),A=a.length-1;0<=A;A--){for(var q=fFilterCardPairArray(a[A].aPair,y,u[a[A].sPair]),
h=[0,0,0,0],w=D.length,c=0;c<w;c++)h[D[c].suit-1]++;for(var n=-1,e=0,c=3;0<=c;c--)3<=h[c]&&(n=c+1,e=h[c]);for(var w=[],k=[],F=q.length,c=0;c<F;c++){var B=q[c],C=0;B[0].suit==n&&C++;B[1].suit==n&&C++;5<=C+e?w.push(B):k.push(B)}h.sort(l.fBigIntFirst);n=h=q=0;0<k.length&&(c=k.length,e=[],e=k[0].concat(f).concat(m[t]),k=l.fGetBestHand(e),"undefined"==typeof k&&fLogCards(e,"Something went wrong here 135"),e=-1*l.fCompareHand(z,k),q=0<e?c:q,h=0===e?c:h,n=0>e?c:n,b+=q,p+=h,g+=n,r+=c,fAddToRecordDic(s,l.fHandToString(k),
-1*e,c),fAddToRecordDic(v,l.fHandToString(z),e,c,!0));for(c=0;c<w.length;c++)e=w[c].concat(f).concat(m[t]),k=l.fGetBestHand(e),e=-1*l.fCompareHand(z,k),q=0<e?++q:q,h=0===e?++h:h,n=0>e?++n:n,b=0<e?++b:b,p=0===e?++p:p,g=0>e?++g:g,r++,fAddToRecordDic(s,l.fHandToString(k),-1*e,1),fAddToRecordDic(v,l.fHandToString(z),e,1,!0)}c=r/x;0===r%500&&self.fPostProgress({iCountWon:b,iCountLost:g,iCountDraw:p,total:r,currentPercent:c})}a=(new Date).getTime();fPostConsole("operation took "+(a-E)/1E3+"s");fPostConsole("approximation of total "+
x+" real total "+r);self.fPostDone({iCountWon:b,iCountLost:g,iCountDraw:p,total:r,oHeroStat:v,oVillainStat:s})};
var fLogCards=function(a,d){d||(d=0);for(var b=d+" logged hand",f=0;f<a.length;f++)b=b+" "+nsConvert.rankNumberToChard(a[f].rank)+nsConvert.suitToDisplayChar(a[f].suit)+" ";fPostConsole(b)},fCardsToKey=function(a){for(var d="k_",b=0;b<a.length;b++)d=d+nsConvert.rankNumberToChard(a[b].rank)+a[b].suit;return d},fLogPairs=function(a,d){d||(d=0);for(var b=d+" logged hand",f=0;f<a.length;f++)b=b+" "+nsConvert.rankNumberToChard(a[f][0].rank)+nsConvert.suitToDisplayChar(a[f][0].suit)+" "+nsConvert.rankNumberToChard(a[f][1].rank)+
nsConvert.suitToDisplayChar(a[f][1].suit);fPostConsole(b)},fAddToRecordDic=function(a,d,b,f,g){"undefined"==typeof a[d]&&(a[d]={},a[d].wonCount=0,a[d].drawCount=0,a[d].lossCount=0);0<b?a[d].wonCount+=f:0===b?a[d].drawCount+=f:a[d].lossCount+=f},fGetStartingHandsFromRangeArray=function(a,d){for(var b=[],f=a.length,g=0;g<f;g++)var u=fGetCardPairFromString(a[g]),u=nsConvert.fGetCardArrayFromPair(u,d),b=b.concat(u);return b},fPostConsole=function(a){self.postMessage({type:"console",msg:a})},fPostDone=
function(a){self.postMessage({type:"done",msg:a})},fPostProgress=function(a){self.postMessage({type:"progress",msg:a})};
